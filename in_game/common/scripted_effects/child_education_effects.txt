# Auto Child Education - Select best education based on child's modifiers
# Version 2.0 - Rewritten for EU5 1.0.9+ compatibility

# Main effect: assigns the optimal education based on the child's stat modifiers
# Skips prodigy/gifted (they cap stats regardless), heirs (player should manage), 
# and expensive education (never downgrade)
select_best_child_education_trait_based = {
	# NEVER change expensive education once set
	if = {
		limit = { has_child_education = expensive_in_depth_education }
	}
	else = {
		# Save current modifiers
		save_temporary_scope_value_as = {
			name = curr_adm
			value = modifier:character_adm_child_education
		}
		save_temporary_scope_value_as = {
			name = curr_dip
			value = modifier:character_dip_child_education
		}
		save_temporary_scope_value_as = {
			name = curr_mil
			value = modifier:character_mil_child_education
		}
		
		# Compute base modifiers by removing current education bonuses
		if = {
			limit = { has_child_education = administrative_education }
			save_temporary_scope_value_as = { name = base_adm value = { value = scope:curr_adm subtract = 0.75 } }
			save_temporary_scope_value_as = { name = base_dip value = { value = scope:curr_dip subtract = 0.25 } }
			save_temporary_scope_value_as = { name = base_mil value = { value = scope:curr_mil subtract = 0.25 } }
		}
		else_if = {
			limit = { has_child_education = diplomatic_education }
			save_temporary_scope_value_as = { name = base_adm value = { value = scope:curr_adm subtract = 0.25 } }
			save_temporary_scope_value_as = { name = base_dip value = { value = scope:curr_dip subtract = 0.75 } }
			save_temporary_scope_value_as = { name = base_mil value = { value = scope:curr_mil subtract = 0.25 } }
		}
		else_if = {
			limit = { has_child_education = military_education }
			save_temporary_scope_value_as = { name = base_adm value = { value = scope:curr_adm subtract = 0.25 } }
			save_temporary_scope_value_as = { name = base_dip value = { value = scope:curr_dip subtract = 0.25 } }
			save_temporary_scope_value_as = { name = base_mil value = { value = scope:curr_mil subtract = 0.75 } }
		}
		else_if = {
			limit = { has_child_education = balanced_education }
			save_temporary_scope_value_as = { name = base_adm value = { value = scope:curr_adm subtract = 0.5 } }
			save_temporary_scope_value_as = { name = base_dip value = { value = scope:curr_dip subtract = 0.5 } }
			save_temporary_scope_value_as = { name = base_mil value = { value = scope:curr_mil subtract = 0.5 } }
		}
		else = {
			# No education yet, use raw modifiers
			save_temporary_scope_value_as = { name = base_adm value = scope:curr_adm }
			save_temporary_scope_value_as = { name = base_dip value = scope:curr_dip }
			save_temporary_scope_value_as = { name = base_mil value = scope:curr_mil }
		}
		
		# Select education based on highest base modifier
		# Priority: ADM > DIP > MIL for ties
		
		# 1. Clear ADM specialist
		if = {
			limit = {
				scope:base_adm > scope:base_dip
				scope:base_adm > scope:base_mil
			}
			set_child_education = child_education:administrative_education
		}
		# 2. Clear DIP specialist  
		else_if = {
			limit = {
				scope:base_dip > scope:base_adm
				scope:base_dip > scope:base_mil
			}
			set_child_education = child_education:diplomatic_education
		}
		# 3. Clear MIL specialist
		else_if = {
			limit = {
				scope:base_mil > scope:base_adm
				scope:base_mil > scope:base_dip
			}
			set_child_education = child_education:military_education
		}
		# 4. ADM-DIP tie (Ambitious trait: +0.33 adm, +0.33 dip)
		else_if = {
			limit = {
				scope:base_adm >= scope:base_dip
				scope:base_adm > scope:base_mil
			}
			set_child_education = child_education:administrative_education
		}
		# 5. ADM-MIL tie (Shrewd trait: +0.33 adm, +0.33 mil)
		else_if = {
			limit = {
				scope:base_adm >= scope:base_mil
				scope:base_adm > scope:base_dip
			}
			set_child_education = child_education:administrative_education
		}
		# 6. DIP-MIL tie (Gallant trait: +0.33 dip, +0.33 mil)
		else_if = {
			limit = {
				scope:base_dip >= scope:base_mil
				scope:base_dip > scope:base_adm
			}
			set_child_education = child_education:diplomatic_education
		}
		# 7. All equal (Prodigy/Gifted/Slow/Idiot or no traits) - rotate
		else = {
			# Initialize counter if needed
			owner = {
				if = { 
					limit = { NOT = { has_variable = ace_generalist_counter } } 
					set_variable = { name = ace_generalist_counter value = 0 } 
				}
			}
			
			# Assign based on counter (0=ADM, 1=DIP, 2=MIL)
			if = {
				limit = { 
					owner = { 
						var:ace_generalist_counter < 1
					} 
				}
				set_child_education = child_education:administrative_education
			}
			else_if = {
				limit = { 
					owner = { 
						var:ace_generalist_counter >= 1
						var:ace_generalist_counter < 2
					} 
				}
				set_child_education = child_education:diplomatic_education
			}
			else = {
				set_child_education = child_education:military_education
			}
			
			# Increment and wrap counter
			owner = {
				change_variable = { name = ace_generalist_counter add = 1 }
				if = { 
					limit = { var:ace_generalist_counter >= 3 } 
					set_variable = { name = ace_generalist_counter value = 0 } 
				}
			}
		}
	}
}

