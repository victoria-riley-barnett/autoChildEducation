# Select best education based on child's education modifiers (like the workshop mod does)
select_best_child_education_trait_based = {
	# First, check if we should try expensive education for special children
	# (heirs, crown estate, high aptitude)
	if = {
		limit = {
			owner = {
				can_pay_price = price:select_expensive_child_education
				# Only spend if we have at least 1000 gold (4x the education cost)
				gold >= 1000
			}
			OR = {
				# Heir gets best treatment (always worth it)
				is_heir_of = owner
				# Crown estate children only if we have extra money
				AND = {
					has_estate = estate_type:crown_estate
					owner = { gold >= 2000 }
				}
				# High aptitude children only if we have extra money
				AND = {
					modifier:character_child_education >= 1
					owner = { gold >= 3000 }
				}
			}
			# Don't waste money on slow/idiot children (negative total modifier)
			modifier:character_child_education >= 0
		}
		set_child_education = child_education:expensive_in_depth_education
		owner = {
			pay_price = price:select_expensive_child_education
		}
	}
	# Check for specific multi-stat traits by their modifier signatures
	# These only apply on FIRST assignment - reassignment uses modifier comparison
	# Ambitious: +0.33 adm, +0.33 dip (total +0.66)
	else_if = {
		limit = { 
			has_child_education_selected = no
			modifier:character_adm_child_education >= 0.33
			modifier:character_dip_child_education >= 0.33
			modifier:character_adm_child_education = modifier:character_dip_child_education
		}
		set_child_education = child_education:administrative_education
	}
	# Gallant: +0.33 dip, +0.33 mil (total +0.66)
	else_if = {
		limit = { 
			has_child_education_selected = no
			modifier:character_dip_child_education >= 0.33
			modifier:character_mil_child_education >= 0.33
			modifier:character_dip_child_education = modifier:character_mil_child_education
		}
		set_child_education = child_education:military_education
	}
	# Shrewd: +0.33 adm, +0.33 mil (total +0.66)
	else_if = {
		limit = { 
			has_child_education_selected = no
			modifier:character_adm_child_education >= 0.33
			modifier:character_mil_child_education >= 0.33
			modifier:character_adm_child_education = modifier:character_mil_child_education
		}
		set_child_education = child_education:administrative_education
	}
	# All other children: use modifier-based assignment/reassignment
	else = {
		# For children with no education yet or balanced education, pick based on distribution/aptitude
		if = {
			limit = {
				OR = {
					has_child_education_selected = no
					has_child_education = balanced_education
				}
			}
			select_best_education_field = yes
		}
		# For children already educated with specialized education, recalculate base modifiers and reassign if needed
		# We need to check if switching would give better specialization
		# Admin education: +0.75 adm, +0.25 dip/mil
		else_if = {
			limit = { has_child_education = administrative_education }
			# Switch to dip if: base_dip > base_adm
			# (current_dip - 0.25) > (current_adm - 0.75)
			# current_dip > current_adm - 0.5
			# But we can't subtract in triggers, so we need to save values
			save_temporary_scope_value_as = {
				name = check_dip
				value = modifier:character_dip_child_education
			}
			save_temporary_scope_value_as = {
				name = check_adm_minus_half
				value = {
					value = modifier:character_adm_child_education
					subtract = 0.5
				}
			}
			if = {
				limit = { scope:check_dip > scope:check_adm_minus_half }
				set_child_education = child_education:diplomatic_education
			}
			else = {
				save_temporary_scope_value_as = {
					name = check_mil
					value = modifier:character_mil_child_education
				}
				if = {
					limit = { scope:check_mil > scope:check_adm_minus_half }
					set_child_education = child_education:military_education
				}
			}
		}
		# Diplomatic education: +0.75 dip, +0.25 adm/mil
		else_if = {
			limit = { has_child_education = diplomatic_education }
			save_temporary_scope_value_as = {
				name = check_adm
				value = modifier:character_adm_child_education
			}
			save_temporary_scope_value_as = {
				name = check_dip_minus_half
				value = {
					value = modifier:character_dip_child_education
					subtract = 0.5
				}
			}
			if = {
				limit = { scope:check_adm > scope:check_dip_minus_half }
				set_child_education = child_education:administrative_education
			}
			else = {
				save_temporary_scope_value_as = {
					name = check_mil
					value = modifier:character_mil_child_education
				}
				if = {
					limit = { scope:check_mil > scope:check_dip_minus_half }
					set_child_education = child_education:military_education
				}
			}
		}
		# Military education: +0.75 mil, +0.25 adm/dip
		else_if = {
			limit = { has_child_education = military_education }
			save_temporary_scope_value_as = {
				name = check_adm
				value = modifier:character_adm_child_education
			}
			save_temporary_scope_value_as = {
				name = check_mil_minus_half
				value = {
					value = modifier:character_mil_child_education
					subtract = 0.5
				}
			}
			if = {
				limit = { scope:check_adm > scope:check_mil_minus_half }
				set_child_education = child_education:administrative_education
			}
			else = {
				save_temporary_scope_value_as = {
					name = check_dip
					value = modifier:character_dip_child_education
				}
				if = {
					limit = { scope:check_dip > scope:check_mil_minus_half }
					set_child_education = child_education:diplomatic_education
				}
			}
		}
	}
}

# Select the best education field based on modifiers
select_best_education_field = {
	# Initial assignment (no education yet) - aim for balanced distribution
	if = {
		limit = {
			OR = {
				has_child_education_selected = no
				has_child_education = balanced_education
			}
		}
		# Count how many children the country already has with each education type
		# This creates a natural ~1/3 distribution
		owner = {
			save_temporary_scope_value_as = {
				name = admin_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = administrative_education
						}
						add = 1
					}
				}
			}
			save_temporary_scope_value_as = {
				name = dip_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = diplomatic_education
						}
						add = 1
					}
				}
			}
			save_temporary_scope_value_as = {
				name = mil_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = military_education
						}
						add = 1
					}
				}
			}
		}
		
		# Pick the education type with fewest children, weighted by aptitude
		random_list = {
			100 = {
				# Favor admin if we have fewer admin-educated children
				modifier = {
					factor = 0.5
					owner = { scope:admin_count > scope:dip_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:admin_count > scope:mil_count }
				}
				# Boost if child has admin aptitude
				modifier = {
					factor = 2
					modifier:character_adm_child_education >= 0.4
				}
				set_child_education = child_education:administrative_education
			}
			100 = {
				modifier = {
					factor = 0.5
					owner = { scope:dip_count > scope:admin_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:dip_count > scope:mil_count }
				}
				modifier = {
					factor = 2
					modifier:character_dip_child_education >= 0.4
				}
				set_child_education = child_education:diplomatic_education
			}
			100 = {
				modifier = {
					factor = 0.5
					owner = { scope:mil_count > scope:admin_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:mil_count > scope:dip_count }
				}
				modifier = {
					factor = 2
					modifier:character_mil_child_education >= 0.4
				}
				set_child_education = child_education:military_education
			}
		}
	}
}