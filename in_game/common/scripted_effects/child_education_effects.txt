# Select best education based on child's education modifiers
select_best_child_education_trait_based = {
	if = {
		limit = { has_child_education = expensive_in_depth_education }
		# Do nothing - keep expensive education forever
	}
	# First, check if we should try expensive education for special children
	# (heirs, crown estate, high aptitude)
	# Only runs once per child - skips if already has expensive education OR already paid
	else_if = {
		limit = {
			is_female = no
			owner = {
				can_pay_price = price:select_expensive_child_education
				# Only spend if we have at least 1000 gold (4x the education cost)
				gold >= 1000
			}
			OR = {
				# Heir gets best treatment (always worth it)
				is_heir_of = owner
				# Crown estate children only if we have extra money
				AND = {
					has_estate = estate_type:crown_estate
					owner = { gold >= 2000 }
				}
				# High aptitude children only if we have extra money
				AND = {
					modifier:character_child_education >= 1
					owner = { gold >= 3000 }
				}
			}
			# Don't waste money on slow/idiot children (negative total modifier)
			modifier:character_child_education >= 0
		}
		set_child_education = child_education:expensive_in_depth_education
		owner = {
			pay_price = price:select_expensive_child_education
		}
	}
	# All other children: always pick the best education based on their current modifiers
	else = {
		# Save current modifiers
		save_temporary_scope_value_as = {
			name = curr_adm
			value = modifier:character_adm_child_education
		}
		save_temporary_scope_value_as = {
			name = curr_dip
			value = modifier:character_dip_child_education
		}
		save_temporary_scope_value_as = {
			name = curr_mil
			value = modifier:character_mil_child_education
		}
		
		# If they have specialized education, calculate base modifiers by removing education bonuses
		# Otherwise base = current (no education bonuses to remove)
		if = {
			limit = { has_child_education = administrative_education }
			save_temporary_scope_value_as = {
				name = base_adm
				value = {
					value = scope:curr_adm
					subtract = 0.75
				}
			}
			save_temporary_scope_value_as = {
				name = base_dip
				value = {
					value = scope:curr_dip
					subtract = 0.25
				}
			}
			save_temporary_scope_value_as = {
				name = base_mil
				value = {
					value = scope:curr_mil
					subtract = 0.25
				}
			}
		}
		else_if = {
			limit = { has_child_education = diplomatic_education }
			save_temporary_scope_value_as = {
				name = base_adm
				value = {
					value = scope:curr_adm
					subtract = 0.25
				}
			}
			save_temporary_scope_value_as = {
				name = base_dip
				value = {
					value = scope:curr_dip
					subtract = 0.75
				}
			}
			save_temporary_scope_value_as = {
				name = base_mil
				value = {
					value = scope:curr_mil
					subtract = 0.25
				}
			}
		}
		else_if = {
			limit = { has_child_education = military_education }
			save_temporary_scope_value_as = {
				name = base_adm
				value = {
					value = scope:curr_adm
					subtract = 0.25
				}
			}
			save_temporary_scope_value_as = {
				name = base_dip
				value = {
					value = scope:curr_dip
					subtract = 0.25
				}
			}
			save_temporary_scope_value_as = {
				name = base_mil
				value = {
					value = scope:curr_mil
					subtract = 0.75
				}
			}
		}
		else = {
			# No education or balanced education - use current modifiers as base
			save_temporary_scope_value_as = {
				name = base_adm
				value = scope:curr_adm
			}
			save_temporary_scope_value_as = {
				name = base_dip
				value = scope:curr_dip
			}
			save_temporary_scope_value_as = {
				name = base_mil
				value = scope:curr_mil
			}
		}
		
		# Now pick the education matching the highest base modifier
		# Detect dual-stat tie patterns first (Gallant/Shrewd), then use >= waterfall
		if = {
			limit = {
				scope:base_dip >= scope:base_mil
				scope:base_mil >= scope:base_dip
				scope:base_dip > scope:base_adm
			}
			# Gallant: dip = mil and both > adm → diplomatic
			set_child_education = child_education:diplomatic_education
		}
		else_if = {
			limit = {
				scope:base_mil >= scope:base_adm
				scope:base_adm >= scope:base_mil
				scope:base_mil > scope:base_dip
			}
			# Shrewd: mil = adm and both > dip → military
			set_child_education = child_education:military_education
		}
		else_if = {
			limit = {
				scope:base_adm >= scope:base_dip
				scope:base_dip >= scope:base_adm
				scope:base_adm >= scope:base_mil
				scope:base_mil >= scope:base_adm
			}
			# All three equal (prodigy, gifted, slow, idiot) → distribute evenly
			# Use modulo on country variable to cycle through education types
			owner = {
				if = {
					limit = { NOT = { has_variable = ace_generalist_counter } }
					set_variable = { name = ace_generalist_counter value = 0 }
				}
				change_variable = { name = ace_generalist_counter add = 1 }
			}
			if = {
				limit = {
					owner = {
						OR = {
							check_variable = { name = ace_generalist_counter value = 1 }
							check_variable = { name = ace_generalist_counter value = 4 }
							check_variable = { name = ace_generalist_counter value = 7 }
						}
					}
				}
				set_child_education = child_education:administrative_education
			}
			else_if = {
				limit = {
					owner = {
						OR = {
							check_variable = { name = ace_generalist_counter value = 2 }
							check_variable = { name = ace_generalist_counter value = 5 }
							check_variable = { name = ace_generalist_counter value = 8 }
						}
					}
				}
				set_child_education = child_education:diplomatic_education
			}
			else = {
				set_child_education = child_education:military_education
				# Reset counter after 9 to keep it small
				owner = {
					if = {
						limit = { check_variable = { name = ace_generalist_counter value = 9 } }
						set_variable = { name = ace_generalist_counter value = 0 }
					}
				}
			}
		}
		else_if = {
			limit = {
				scope:base_adm >= scope:base_dip
				scope:base_adm >= scope:base_mil
			}
			# Ambitious (adm > dip) or adm clearly highest → administrative
			set_child_education = child_education:administrative_education
		}
		else_if = {
			limit = {
				scope:base_dip >= scope:base_mil
			}
			# Dip clearly highest → diplomatic
			set_child_education = child_education:diplomatic_education
		}
		else = {
			# Mil clearly highest → military
			set_child_education = child_education:military_education
		}
	}
}
