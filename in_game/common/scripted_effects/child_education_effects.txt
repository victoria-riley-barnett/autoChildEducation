# Select best education based on child's education modifiers (like the workshop mod does)
select_best_child_education_trait_based = {
	# root = character
	
	# First, check if we should try expensive education for special children
	# (heirs, crown estate, high aptitude)
	if = {
		limit = {
			owner = {
				can_pay_price = price:select_expensive_child_education
				# Only spend if we have at least 1000 gold (4x the education cost)
				gold >= 1000
			}
			OR = {
				# Heir gets best treatment (always worth it)
				is_heir_of = owner
				# Crown estate children only if we have extra money
				AND = {
					has_estate = estate_type:crown_estate
					owner = { gold >= 2000 }
				}
				# High aptitude children only if we have extra money
				AND = {
					modifier:character_child_education >= 1
					owner = { gold >= 3000 }
				}
			}
			NOR = {
				# Don't waste money on slow/idiot children
				modifier:character_child_education < 0
				has_trait = child_slow
				has_trait = child_idiot
			}
		}
		set_child_education = child_education:expensive_in_depth_education
		owner = {
			pay_price = price:select_expensive_child_education
		}
	}
	# Check for specific multi-stat traits and assign their best education
	else_if = {
		limit = { has_trait = child_ambitious }
		# Ambitious: +0.33 adm, +0.3 dip -> administrative focus
		set_child_education = child_education:administrative_education
	}
	else_if = {
		limit = { has_trait = child_gallant }
		# Gallant: +0.33 dip, +0.33 mil -> military focus (warrior diplomat)
		set_child_education = child_education:military_education
	}
	else_if = {
		limit = { has_trait = child_shrewd }
		# Shrewd: +0.33 mil, +0.33 adm -> diplomatic focus (cunning strategist)
		set_child_education = child_education:diplomatic_education
	}
	# Otherwise, select best field-specific education based on aptitudes
	else = {
		# For children with no education yet, just pick based on distribution/aptitude
		if = {
			limit = {
				OR = {
					has_child_education_selected = no
					has_child_education = balanced_education
				}
			}
			select_best_education_field = yes
		}
		# For children already educated, check if they have traits that don't match current education
		else_if = {
			limit = { has_child_education = administrative_education }
			if = {
				limit = {
					OR = {
						# Single-stat traits that don't match
						has_trait = child_gregarious  # +0.5 dip
						has_trait = child_rowdy       # +0.5 mil
						# Dual-stat traits that include non-admin
						has_trait = child_gallant     # +0.33 dip/mil
					}
				}
				select_best_education_field = yes
			}
		}
		else_if = {
			limit = { has_child_education = diplomatic_education }
			if = {
				limit = {
					OR = {
						has_trait = child_intelligent # +0.5 adm
						has_trait = child_rowdy       # +0.5 mil
						has_trait = child_shrewd      # +0.33 adm/mil
					}
				}
				select_best_education_field = yes
			}
		}
		else_if = {
			limit = { has_child_education = military_education }
			if = {
				limit = {
					OR = {
						has_trait = child_intelligent # +0.5 adm
						has_trait = child_gregarious  # +0.5 dip
						has_trait = child_ambitious   # +0.33 adm/dip
					}
				}
				select_best_education_field = yes
			}
		}
	}
}

# Select the best education field based on modifiers
# This is called AFTER we've decided to assign/reassign education
# For initial assignment, we aim for balanced distribution (1/3 each type)
# For reassignment, we pick based on highest aptitude (trait-driven)
select_best_education_field = {
	# root = character
	
	# Initial assignment (no education yet) - aim for balanced distribution
	if = {
		limit = {
			OR = {
				has_child_education_selected = no
				has_child_education = balanced_education
			}
		}
		# Count how many children the country already has with each education type
		# This creates a natural ~1/3 distribution
		owner = {
			save_temporary_scope_value_as = {
				name = admin_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = administrative_education
						}
						add = 1
					}
				}
			}
			save_temporary_scope_value_as = {
				name = dip_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = diplomatic_education
						}
						add = 1
					}
				}
			}
			save_temporary_scope_value_as = {
				name = mil_count
				value = {
					value = 0
					every_character = {
						limit = {
							has_trait_category = child
							has_child_education = military_education
						}
						add = 1
					}
				}
			}
		}
		
		# Pick the education type with fewest children, weighted by aptitude
		random_list = {
			100 = {
				# Favor admin if we have fewer admin-educated children
				modifier = {
					factor = 0.5
					owner = { scope:admin_count > scope:dip_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:admin_count > scope:mil_count }
				}
				# Boost if child has admin aptitude
				modifier = {
					factor = 2
					modifier:character_adm_child_education >= 0.4
				}
				set_child_education = child_education:administrative_education
			}
			100 = {
				modifier = {
					factor = 0.5
					owner = { scope:dip_count > scope:admin_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:dip_count > scope:mil_count }
				}
				modifier = {
					factor = 2
					modifier:character_dip_child_education >= 0.4
				}
				set_child_education = child_education:diplomatic_education
			}
			100 = {
				modifier = {
					factor = 0.5
					owner = { scope:mil_count > scope:admin_count }
				}
				modifier = {
					factor = 0.5
					owner = { scope:mil_count > scope:dip_count }
				}
				modifier = {
					factor = 2
					modifier:character_mil_child_education >= 0.4
				}
				set_child_education = child_education:military_education
			}
		}
	}
	# Reassignment - pick based on highest current aptitude
	else = {
		# At this point, the calling code has already verified that switching makes sense
		random_list = {
			10 = {
				modifier = {
					add = modifier:character_adm_child_education
					multiply = 10
				}
				trigger = {
					modifier:character_adm_child_education >= modifier:character_dip_child_education
					modifier:character_adm_child_education >= modifier:character_mil_child_education
				}
				set_child_education = child_education:administrative_education
			}
			10 = {
				modifier = {
					add = modifier:character_dip_child_education
					multiply = 10
				}
				trigger = {
					modifier:character_dip_child_education >= modifier:character_adm_child_education
					modifier:character_dip_child_education >= modifier:character_mil_child_education
				}
				set_child_education = child_education:diplomatic_education
			}
			10 = {
				modifier = {
					add = modifier:character_mil_child_education
					multiply = 10
				}
				trigger = {
					modifier:character_mil_child_education >= modifier:character_dip_child_education
					modifier:character_mil_child_education >= modifier:character_adm_child_education
				}
				set_child_education = child_education:military_education
			}
		}
	}
}